#!/usr/bin/ruby

require 'rawstools'
require 'optparse'

cfgfile = ENV["RAWS_CLOUDCFG"]

opts = OptionParser.new

opts.banner = <<-EOF
Usage: rds <command> (options) (args) - manage a CloudFormation stack
 Where <command> is one of:
  create <name> <rootpassword> <template> - create an rds db instance from a template (name or path) with the provided root password
  snapshot <name> - take a snapshot of the db instance <name>
  template - dump the default template for creating db instances
  delete <name> - delete a db instance
  updatedns <name> - refresh DNS CNAME for the db instance
  list instances - list db instances for the current project
  list snapshots (name) - list db snapshots for the current project, optionally for a single db instance
 Options are:
EOF
opts.on("-c", "--configfile FILE", "Use FILE for cloud configuration instead of ./cloudconfig.yaml") do |file|
	cfgfile = file
end

class UsageException < Exception
	def initialize(msg="Invalid command / option / argument")
		super(msg)
	end
end

begin

commands = [ "create", "list", "rename", "snapshot", "delete", "template", "updatedns" ]
command = ARGV.shift()
raise UsageException.new("Missing <command>") unless command
raise UsageException.new("Unknown command: #{command}") unless commands.include?(command)

params = {}
tags = {}
wait = false
datasize = nil
unsafe = false

case command
when "create"
	opts.on("-d", "--data-size SIZE", "Create with allocated storage of size SIZE") do |dsize|
		params["datasize"] = dsize
	end
	opts.on("-w", "--wait", "Wait for all operations to complete before exiting") do
		wait = true
	end
	opts.on("-i", "--iops IOPS", "Specify provisioned iops, only used with io1 storage") do |iops|
		params["iops"] = iops
	end
	opts.on("-s", "--snapshot SNAP", "Create db instance from snapshot with identifier SNAP") do |snap|
		params["snapname"] = snap
	end
	opts.on("-S", "--storage-type TYPE", "Create with storage of type TYPE (gp2, io1, etc.)") do |stype|
		params["storage_type"] = stype
	end
	opts.on("-t", "--db-instance-type TYPE", "Use TYPE for db instance type instead of template default") do |type|
		params["type"] = type
	end
	opts.on("-z", "--availability-zone ZONE", "Create db instance in the given zone (letter only)") do |zone|
		params["az"] = zone
	end
	opts.on("-T", "--tag KEYVAL", "Add tag where KEYVAL is of the form key=value") do |keyval|
		e = keyval.index("=")
		key = keyval[0..(e-1)]
		value = keyval[(e+1)..-1]
		tags[key] = value
	end
	opts.on("-p", "--parameter PARAMVAL", "Set an arbitrary parameter where PARAMVAL is of the form parameter=value") do |keyval|
		e = keyval.index("=")
		key = keyval[0..(e-1)]
		value = keyval[(e+1)..-1]
		params[key] = value
	end
when "updatedns", "delete"
	opts.on("-w", "--wait", "Wait for all operations to complete before exiting") do
		wait = true
	end
	if command == "delete"
		opts.on("-u", "--unsafe", "Don't create a final snapshot") do
			unsafe = true
		end
	end
end

opts.parse!

cfgfile = "cloudconfig.yaml" unless cfgfile

raise UsageException.new("Missing configuration file: #{cfgfile}") unless File::exist?(cfgfile)
raise UsageException.new("Not a regular file: #{cfgfile}") unless File::stat(cfgfile).file?

cfg = RAWSTools::CloudManager.new(cfgfile)
cfg.setparams(params)

case command
when "list"
  type = ARGV.shift()
  raise "Missing <instances|snapshots> in list command" unless type
  case type
  when "instances"
  	format = "%-15s %-15s %-14s %-19s"
  	puts format % [ "Name", "Identifier", "Instance class", "Allocated storage" ]
  	cfg.rds.list_instances().each() do |i|
  		puts format % [ cfg.rds.get_tag(i, "Name"), i.db_instance_identifier, i.db_instance_class, i.allocated_storage ]
  	end
  when "snapshots"
    format = "%-15s %-35s %-24s %-14s"
    puts format % [ "Name", "Identifier", "Created", "Storage Size" ]
    cfg.rds.list_snapshots(ARGV.shift()).each do |s|
      puts format % [ cfg.rds.get_tag(s, "Name"), s.db_snapshot_identifier, s.snapshot_create_time ,s.allocated_storage ]
    end
  end
when "create"
	name, rootpass, template = ARGV.shift(3)
	raise UsageException.new("Missing required argument") unless template
	dbinstance = cfg.rds.create_instance(name, rootpass, template, wait) { |status| puts status }
when "template"
	cfg.rds.dump_template()
when "updatedns"
  name = ARGV.shift()
  raise UsageException.new("Missing required name argument") unless name
  cfg.rds.update_dns(name, wait) { |status| puts status }
when "snapshot"
	name = ARGV.shift()
	raise UsageException.new("Missing <name> argument") unless name
	cfg.rds.create_snapshot(name, wait) { |status| puts status }
when "delete"
	name = ARGV.shift()
	raise UsageException.new("Missing <name> argument") unless name
	cfg.rds.delete_instance(name, wait, unsafe) { |status| puts status }
end

rescue UsageException => e
	puts "\n#{e.message}\n\n"
	puts opts.help()
end
